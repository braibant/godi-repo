diff -b -B -u -r ../work.orig/tcl8.6.1/generic/tcl.h ./tcl8.6.1/generic/tcl.h
--- ../work.orig/tcl8.6.1/generic/tcl.h	2013-09-19 21:04:14.000000000 +0200
+++ ./tcl8.6.1/generic/tcl.h	2014-05-09 23:27:33.661029995 +0200
@@ -390,7 +390,7 @@
  */
 
 #if !defined(TCL_WIDE_INT_TYPE)&&!defined(TCL_WIDE_INT_IS_LONG)
-#   if defined(__WIN32__)
+#   if defined(__WIN32__) && !defined(__USE_MINGW_ANSI_STDIO)
 #      define TCL_WIDE_INT_TYPE __int64
 #      ifdef __BORLANDC__
 #         define TCL_LL_MODIFIER	"L"
diff -b -B -u -r ../work.orig/tcl8.6.1/generic/tclInt.h ./tcl8.6.1/generic/tclInt.h
--- ../work.orig/tcl8.6.1/generic/tclInt.h	2013-09-19 21:04:14.000000000 +0200
+++ ./tcl8.6.1/generic/tclInt.h	2014-05-09 23:27:33.661029995 +0200
@@ -3160,7 +3160,7 @@
 MODULE_SCOPE int	TclClockOldscanObjCmd(
 			    ClientData clientData, Tcl_Interp *interp,
 			    int objc, Tcl_Obj *const objv[]);
-MODULE_SCOPE int	Tcl_CloseObjCmd(ClientData clientData,
+extern int	Tcl_CloseObjCmd(ClientData clientData,
 			    Tcl_Interp *interp, int objc,
 			    Tcl_Obj *const objv[]);
 MODULE_SCOPE int	Tcl_ConcatObjCmd(ClientData clientData,
@@ -3343,7 +3343,7 @@
 MODULE_SCOPE int	Tcl_RepresentationCmd(ClientData clientData,
 			    Tcl_Interp *interp, int objc,
 			    Tcl_Obj *const objv[]);
-MODULE_SCOPE int	Tcl_ReturnObjCmd(ClientData clientData,
+extern int	Tcl_ReturnObjCmd(ClientData clientData,
 			    Tcl_Interp *interp, int objc,
 			    Tcl_Obj *const objv[]);
 MODULE_SCOPE int	Tcl_ScanObjCmd(ClientData clientData,
Nur in ./tcl8.6.1/generic: tclInt.h.orig.
diff -b -B -u -r ../work.orig/tcl8.6.1/generic/tclPort.h ./tcl8.6.1/generic/tclPort.h
--- ../work.orig/tcl8.6.1/generic/tclPort.h	2013-09-19 21:04:14.000000000 +0200
+++ ./tcl8.6.1/generic/tclPort.h	2014-05-09 23:27:33.661029995 +0200
@@ -20,7 +20,7 @@
 #if defined(_WIN32)
 #   include "tclWinPort.h"
 #else
-#   include "tclUnixPort.h"
+#   include "../unix/tclUnixPort.h"
 #endif
 #include "tcl.h"
 
diff -b -B -u -r ../work.orig/tcl8.6.1/unix/installManPage ./tcl8.6.1/unix/installManPage
--- ../work.orig/tcl8.6.1/unix/installManPage	2013-09-19 22:17:13.000000000 +0200
+++ ./tcl8.6.1/unix/installManPage	2014-05-09 23:27:33.653029761 +0200
@@ -103,7 +103,7 @@
     Target=$Target.$Section$Suffix
     rm -f $Dir/$Target $Dir/$Target.*
     if test -z "$First" ; then
-	First=$Target
+	First=$(echo $Target | sed -e 's/:/-/g')
 	sed -e "/man\.macros/r $SrcDir/man.macros" -e "/man\.macros/d" \
 	    $ManPage > $Dir/$First
 	chmod 444 $Dir/$First
Nur in ./tcl8.6.1/unix: installManPage.orig.
diff -b -B -u -r ../work.orig/tcl8.6.1/win/configure.in ./tcl8.6.1/win/configure.in
--- ../work.orig/tcl8.6.1/win/configure.in	2013-09-19 22:17:14.000000000 +0200
+++ ./tcl8.6.1/win/configure.in	2014-05-09 23:27:33.661029995 +0200
@@ -105,15 +105,7 @@
 
 SC_CONFIG_CFLAGS
 
-# Cross-compiling
-case ${host_alias} in
-*mingw32*)
-    TCL_EXE="tclsh"
-    ;;
-*)
     TCL_EXE="TCL_LIBRARY=\"\${LIBRARY_DIR}\"; export TCL_LIBRARY; ./\${TCLSH}"
-    ;;
-esac
 
 #------------------------------------------------------------------------
 #	Add stuff for zlib; note that this is mostly done in the makefile now
@@ -126,17 +118,9 @@
 ], [
   tcl_ok=yes
 ])
+zlibflags=`pkg-config --libs zlib`
 AS_IF([test "$tcl_ok" = "yes"], [
-  AC_SUBST(ZLIB_DLL_FILE,[\${ZLIB_DLL_FILE}])
-  AS_IF([test "$do64bit" = "yes"], [
-    AS_IF([test "$GCC" == "yes"],[
-      AC_SUBST(ZLIB_LIBS,[\${ZLIB_DIR}/win64/libz.dll.a])
-    ], [
-      AC_SUBST(ZLIB_LIBS,[\${ZLIB_DIR}/win64/zdll.lib])
-    ])
-  ], [
-    AC_SUBST(ZLIB_LIBS,[\${ZLIB_DIR}/win32/zdll.lib])
-  ])
+    AC_SUBST(ZLIB_LIBS,[$zlibflags])
 ], [
   AC_SUBST(ZLIB_OBJS,[\${ZLIB_OBJS}])
 ])
@@ -301,7 +285,13 @@
 eval "TCL_BUILD_STUB_LIB_PATH=\"`pwd`/${TCL_STUB_LIB_FILE}\""
 eval "TCL_STUB_LIB_PATH=\"${libdir}/${TCL_STUB_LIB_FILE}\""
 
-eval "TCL_LIB_FILE=\"${LIBPREFIX}tcl${VER}${LIBSUFFIX}\""
+if test ${SHARED_BUILD} = 0 ; then
+ eval "TCL_LIB_FILE=\"${LIBPREFIX}tcl${VER}${LIBSUFFIX}\""
+else
+ eval "TCL_LIB_FILE=\"${LIBPREFIX}tcl${VER}${DLLSUFFIX}${LIBSUFFIX}\""
+fi
+
+
 eval "TCL_BUILD_LIB_SPEC=\"-L`pwd` -ltcl${VER}${FLAGSUFFIX}\""
 eval "TCL_LIB_SPEC=\"-L${libdir} -ltcl${VER}${FLAGSUFFIX}\""
 
diff -b -B -u -r ../work.orig/tcl8.6.1/win/Makefile.in ./tcl8.6.1/win/Makefile.in
--- ../work.orig/tcl8.6.1/win/Makefile.in	2013-09-19 22:17:14.000000000 +0200
+++ ./tcl8.6.1/win/Makefile.in	2014-05-09 23:27:33.657029878 +0200
@@ -102,6 +102,8 @@
 COMPAT_DIR		= $(TOP_DIR)/compat
 PKGS_DIR		= $(TOP_DIR)/pkgs
 ZLIB_DIR		= $(COMPAT_DIR)/zlib
+BUILD_DIR		= @builddir@
+UNIX_DIR		= $(TOP_DIR)/unix
 
 # Converts a POSIX path to a Windows native path.
 CYGPATH			= @CYGPATH@
@@ -134,14 +136,13 @@
 TCL_DLL_FILE		= @TCL_DLL_FILE@
 TCL_LIB_FILE		= @TCL_LIB_FILE@
 DDE_DLL_FILE		= tcldde$(DDEVER)${DLLSUFFIX}
-DDE_LIB_FILE		= @LIBPREFIX@tcldde$(DDEVER)${LIBSUFFIX}
+DDE_LIB_FILE		= @LIBPREFIX@tcldde$(DDEVER)${DLLSUFFIX}${LIBSUFFIX}
 REG_DLL_FILE		= tclreg$(REGVER)${DLLSUFFIX}
-REG_LIB_FILE		= @LIBPREFIX@tclreg$(REGVER)${LIBSUFFIX}
+REG_LIB_FILE		= @LIBPREFIX@tclreg$(REGVER)${DLLSUFFIX}${LIBSUFFIX}
 TEST_DLL_FILE		= tcltest$(VER)${DLLSUFFIX}
-TEST_LIB_FILE		= @LIBPREFIX@tcltest$(VER)${LIBSUFFIX}
-ZLIB_DLL_FILE		= zlib1.dll
+TEST_LIB_FILE		= @LIBPREFIX@tcltest$(VER)${DLLSUFFIX}${LIBSUFFIX}
 
-SHARED_LIBRARIES 	= $(TCL_DLL_FILE) @ZLIB_DLL_FILE@
+SHARED_LIBRARIES 	= $(TCL_DLL_FILE)
 STATIC_LIBRARIES	= $(TCL_LIB_FILE)
 
 TCLSH			= tclsh$(VER)${EXESUFFIX}
@@ -189,6 +190,12 @@
 RM		= rm -f
 COPY		= cp
 
+INSTALL			= $(SHELL) $(UNIX_DIR)/install-sh -c
+INSTALL_PROGRAM		= ${INSTALL}
+INSTALL_LIBRARY		= ${INSTALL}
+INSTALL_DATA		= ${INSTALL} -m 644
+INSTALL_DATA_DIR	= ${INSTALL} -d -m 755
+
 CC_SWITCHES = ${CFLAGS} ${CFLAGS_WARNING} ${TCL_SHLIB_CFLAGS} -I"${ZLIB_DIR}" \
 -I"${GENERIC_DIR_NATIVE}" -DTCL_TOMMATH -DMP_PREC=4 -I"${TOMMATH_DIR_NATIVE}" \
 -I"${WIN_DIR_NATIVE}" ${AC_FLAGS} \
@@ -436,7 +443,7 @@
 	@MAKE_LIB@ ${STUB_OBJS}
 	@POST_MAKE_LIB@
 
-${TCL_DLL_FILE}: ${TCL_OBJS} tcl.$(RES) @ZLIB_DLL_FILE@
+${TCL_DLL_FILE}: ${TCL_OBJS} tcl.$(RES)
 	@$(RM) ${TCL_DLL_FILE} $(TCL_LIB_FILE)
 	@MAKE_DLL@ ${TCL_OBJS} tcl.$(RES) $(SHLIB_LD_LIBS)
 	@VC_MANIFEST_EMBED_DLL@
@@ -456,14 +463,6 @@
 	@$(RM) ${TEST_DLL_FILE} ${TEST_LIB_FILE}
 	@MAKE_DLL@ ${TCLTEST_OBJS} $(TCL_STUB_LIB_FILE) $(SHLIB_LD_LIBS)
 
-# use pre-built zlib1.dll
-${ZLIB_DLL_FILE}: ${TCL_STUB_LIB_FILE}
-	@if test "@ZLIB_LIBS@set" != "${ZLIB_DIR}/win32/zdll.libset" ; then \
-		$(COPY) $(ZLIB_DIR)/win64/${ZLIB_DLL_FILE} ${ZLIB_DLL_FILE}; \
-	else \
-		$(COPY) $(ZLIB_DIR)/win32/${ZLIB_DLL_FILE} ${ZLIB_DLL_FILE}; \
-	fi;
-
 # Add the object extension to the implicit rules. By default .obj is not
 # automatically added.
 
@@ -556,8 +555,7 @@
 	    do \
 	    if [ ! -d $$i ] ; then \
 		echo "Making directory $$i"; \
-		$(MKDIR) $$i; \
-		chmod 755 $$i; \
+		$(INSTALL_DATA_DIR) $$i; \
 		else true; \
 		fi; \
 	    done;
@@ -565,43 +563,43 @@
 	    do \
 	    if [ ! -d $(LIB_INSTALL_DIR)/$$i ] ; then \
 		echo "Making directory $(LIB_INSTALL_DIR)/$$i"; \
-		$(MKDIR) $(LIB_INSTALL_DIR)/$$i; \
+		$(INSTALL_DATA_DIR) $(LIB_INSTALL_DIR)/$$i; \
 		else true; \
 		fi; \
 	    done;
-	@for i in $(TCL_DLL_FILE) $(ZLIB_DLL_FILE) $(TCLSH); \
+	@for i in $(TCL_DLL_FILE) $(TCLSH); \
 	    do \
 	    if [ -f $$i ]; then \
 		echo "Installing $$i to $(BIN_INSTALL_DIR)/"; \
-		$(COPY) $$i "$(BIN_INSTALL_DIR)"; \
+		$(INSTALL_PROGRAM) $$i "$(BIN_INSTALL_DIR)"; \
 	    fi; \
 	    done
 	@for i in tclConfig.sh tclooConfig.sh $(TCL_LIB_FILE) $(TCL_STUB_LIB_FILE); \
 	    do \
 	    if [ -f $$i ]; then \
 		echo "Installing $$i to $(LIB_INSTALL_DIR)/"; \
-		$(COPY) $$i "$(LIB_INSTALL_DIR)"; \
+		$(INSTALL_DATA) $$i "$(LIB_INSTALL_DIR)"; \
 	    fi; \
 	    done
 	@if [ -f $(DDE_DLL_FILE) ]; then \
 	    echo Installing $(DDE_DLL_FILE); \
-	    $(COPY) $(DDE_DLL_FILE) $(LIB_INSTALL_DIR)/dde${DDEDOTVER}; \
-	    $(COPY) $(ROOT_DIR)/library/dde/pkgIndex.tcl \
+	    $(INSTALL_LIBRARY) $(DDE_DLL_FILE) $(LIB_INSTALL_DIR)/dde${DDEDOTVER}; \
+	    $(INSTALL_LIBRARY) $(ROOT_DIR)/library/dde/pkgIndex.tcl \
 		$(LIB_INSTALL_DIR)/dde${DDEDOTVER}; \
 	    fi
 	@if [ -f $(DDE_LIB_FILE) ]; then \
 	    echo Installing $(DDE_LIB_FILE); \
-	    $(COPY) $(DDE_LIB_FILE) $(LIB_INSTALL_DIR)/dde${DDEDOTVER}; \
+	    $(INSTALL_DATA) $(DDE_LIB_FILE) $(LIB_INSTALL_DIR)/dde${DDEDOTVER}; \
 	    fi
 	@if [ -f $(REG_DLL_FILE) ]; then \
 	    echo Installing $(REG_DLL_FILE); \
-	    $(COPY) $(REG_DLL_FILE) $(LIB_INSTALL_DIR)/reg${REGDOTVER}; \
-	    $(COPY) $(ROOT_DIR)/library/reg/pkgIndex.tcl \
+	    $(INSTALL_LIBRARY) $(REG_DLL_FILE) $(LIB_INSTALL_DIR)/reg${REGDOTVER}; \
+	    $(INSTALL_LIBRARY) $(ROOT_DIR)/library/reg/pkgIndex.tcl \
 		$(LIB_INSTALL_DIR)/reg${REGDOTVER}; \
 	    fi
 	@if [ -f $(REG_LIB_FILE) ]; then \
 	    echo Installing $(REG_LIB_FILE); \
-	    $(COPY) $(REG_LIB_FILE) $(LIB_INSTALL_DIR)/reg${REGDOTVER}; \
+	    $(INSTALL_DATA) $(REG_LIB_FILE) $(LIB_INSTALL_DIR)/reg${REGDOTVER}; \
 	    fi
 
 install-libraries: libraries install-tzdata install-msgs
@@ -610,7 +608,7 @@
 	    do \
 	    if [ ! -d $$i ] ; then \
 		echo "Making directory $$i"; \
-		$(MKDIR) $$i; \
+		$(INSTALL_DATA_DIR) $$i; \
 		else true; \
 		fi; \
 	    done;
@@ -618,7 +616,7 @@
 	    do \
 	    if [ ! -d $(SCRIPT_INSTALL_DIR)/$$i ] ; then \
 		echo "Making directory $(SCRIPT_INSTALL_DIR)/$$i"; \
-		$(MKDIR) $(SCRIPT_INSTALL_DIR)/$$i; \
+		$(INSTALL_DATA_DIR) $(SCRIPT_INSTALL_DIR)/$$i; \
 		else true; \
 		fi; \
 	    done;
@@ -629,36 +627,36 @@
 		"$(GENERIC_DIR)/tclTomMath.h" \
 		"$(GENERIC_DIR)/tclTomMathDecls.h"; \
 	    do \
-	    $(COPY) "$$i" "$(INCLUDE_INSTALL_DIR)"; \
+	    $(INSTALL_DATA) "$$i" "$(INCLUDE_INSTALL_DIR)"; \
 	    done;
 	@echo "Installing library files to $(SCRIPT_INSTALL_DIR)";
 	@for i in $(ROOT_DIR)/library/*.tcl $(ROOT_DIR)/library/tclIndex; \
 	    do \
-	    $(COPY) "$$i" "$(SCRIPT_INSTALL_DIR)"; \
+	    $(INSTALL_DATA) "$$i" "$(SCRIPT_INSTALL_DIR)"; \
 	    done;
 	@echo "Installing library http1.0 directory";
 	@for j in $(ROOT_DIR)/library/http1.0/*.tcl; \
 	    do \
-	    $(COPY) "$$j" "$(SCRIPT_INSTALL_DIR)/http1.0"; \
+	    $(INSTALL_DATA) "$$j" "$(SCRIPT_INSTALL_DIR)/http1.0"; \
 	    done;
 	@echo "Installing package http 2.8.7 as a Tcl Module";
-	@$(COPY) $(ROOT_DIR)/library/http/http.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.6/http-2.8.7.tm;
+	@$(INSTALL_DATA) $(ROOT_DIR)/library/http/http.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.6/http-2.8.7.tm;
 	@echo "Installing library opt0.4 directory";
 	@for j in $(ROOT_DIR)/library/opt/*.tcl; \
 	    do \
-	    $(COPY) "$$j" "$(SCRIPT_INSTALL_DIR)/opt0.4"; \
+	    $(INSTALL_DATA) "$$j" "$(SCRIPT_INSTALL_DIR)/opt0.4"; \
 	    done;
 	@echo "Installing package msgcat 1.5.2 as a Tcl Module";
-	@$(COPY) $(ROOT_DIR)/library/msgcat/msgcat.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.5/msgcat-1.5.2.tm;
+	@$(INSTALL_DATA) $(ROOT_DIR)/library/msgcat/msgcat.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.5/msgcat-1.5.2.tm;
 	@echo "Installing package tcltest 2.3.6 as a Tcl Module";
-	@$(COPY) $(ROOT_DIR)/library/tcltest/tcltest.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.5/tcltest-2.3.6.tm;
+	@$(INSTALL_DATA) $(ROOT_DIR)/library/tcltest/tcltest.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.5/tcltest-2.3.6.tm;
 	@echo "Installing package platform 1.0.12 as a Tcl Module";
-	@$(COPY) $(ROOT_DIR)/library/platform/platform.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.4/platform-1.0.12.tm;
+	@$(INSTALL_DATA) $(ROOT_DIR)/library/platform/platform.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.4/platform-1.0.12.tm;
 	@echo "Installing package platform::shell 1.1.4 as a Tcl Module";
-	@$(COPY) $(ROOT_DIR)/library/platform/shell.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.4/platform/shell-1.1.4.tm;
+	@$(INSTALL_DATA) $(ROOT_DIR)/library/platform/shell.tcl $(SCRIPT_INSTALL_DIR)/../tcl8/8.4/platform/shell-1.1.4.tm;
 	@echo "Installing encodings";
 	@for i in $(ROOT_DIR)/library/encoding/*.enc ; do \
-		$(COPY) "$$i" "$(SCRIPT_INSTALL_DIR)/encoding"; \
+		$(INSTALL_DATA) "$$i" "$(SCRIPT_INSTALL_DIR)/encoding"; \
 	done;
 
 install-tzdata:
@@ -672,6 +670,28 @@
 	    "$(ROOT_DIR)/library/msgs" "$(SCRIPT_INSTALL_DIR)/msgs"
 
 install-doc: doc
+	@for i in "$(MAN_INSTALL_DIR)" "$(MAN1_INSTALL_DIR)" "$(MAN3_INSTALL_DIR)" "$(MANN_INSTALL_DIR)" ; \
+	    do \
+	    if [ ! -d "$$i" ] ; then \
+		echo "Making directory $$i"; \
+		$(INSTALL_DATA_DIR) "$$i"; \
+		else true; \
+		fi; \
+	    done;
+	@echo "Installing and cross-linking top-level (.1) docs to $(MAN1_INSTALL_DIR)/";
+	@for i in $(TOP_DIR)/doc/*.1; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MAN1_INSTALL_DIR)"; \
+	done
+
+	@echo "Installing and cross-linking C API (.3) docs to $(MAN3_INSTALL_DIR)/";
+	@for i in $(TOP_DIR)/doc/*.3; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MAN3_INSTALL_DIR)"; \
+	done
+
+	@echo "Installing and cross-linking command (.n) docs to $(MANN_INSTALL_DIR)/";
+	@for i in $(TOP_DIR)/doc/*.n; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MANN_INSTALL_DIR)"; \
+	done
 
 # Optional target to install private headers
 install-private-headers: libraries
@@ -679,7 +699,7 @@
 	    do \
 	    if [ ! -d $$i ] ; then \
 		echo "Making directory $$i"; \
-		$(MKDIR) $$i; \
+		$(INSTALL_DATA_DIR) $$i; \
 		else true; \
 		fi; \
 	    done;
@@ -689,7 +709,7 @@
 		"$(GENERIC_DIR)/tclOOInt.h" "$(GENERIC_DIR)/tclOOIntDecls.h" \
 		"$(WIN_DIR)/tclWinPort.h" ; \
 	    do \
-	    $(COPY) "$$i" "$(PRIVATE_INCLUDE_INSTALL_DIR)"; \
+	    $(INSTALL_DATA) "$$i" "$(PRIVATE_INCLUDE_INSTALL_DIR)"; \
 	    done;
 
 # Specifying TESTFLAGS on the command line is the standard way to pass args to
diff -b -B -u -r ../work.orig/tcl8.6.1/win/tcl.m4 ./tcl8.6.1/win/tcl.m4
--- ../work.orig/tcl8.6.1/win/tcl.m4	2013-09-19 22:17:14.000000000 +0200
+++ ./tcl8.6.1/win/tcl.m4	2014-05-09 23:27:33.657029878 +0200
@@ -715,7 +715,7 @@
 	SHLIB_LD='${CC} -shared ${CFLAGS}'
 	SHLIB_LD_LIBS='${LIBS}'
 	MAKE_DLL="\${SHLIB_LD} \$(LDFLAGS) -o \[$]@ ${extra_ldflags} \
-	    -Wl,--out-implib,\$(patsubst %.dll,lib%.a,\[$]@)"
+	    -Wl,--out-implib,\$(patsubst %.dll,lib%.dll.a,\[$]@)"
 	# DLLSUFFIX is separate because it is the building block for
 	# users of tclConfig.sh that may build shared or static.
 	DLLSUFFIX="\${DBGX}.dll"
diff -b -B -u -r ../work.orig/tcl8.6.1/win/tclWin32Dll.c ./tcl8.6.1/win/tclWin32Dll.c
--- ../work.orig/tcl8.6.1/win/tclWin32Dll.c	2013-09-19 21:04:17.000000000 +0200
+++ ./tcl8.6.1/win/tclWin32Dll.c	2014-05-09 23:27:33.653029761 +0200
@@ -29,17 +29,17 @@
 /*
  * Unlike Borland and Microsoft, we don't register exception handlers by
  * pushing registration records onto the runtime stack. Instead, we register
- * them by creating an EXCEPTION_REGISTRATION within the activation record.
+ * them by creating an TCL_EXCEPTION_REGISTRATION within the activation record.
  */
 
-typedef struct EXCEPTION_REGISTRATION {
-    struct EXCEPTION_REGISTRATION *link;
+typedef struct TCL_EXCEPTION_REGISTRATION {
+    struct TCL_EXCEPTION_REGISTRATION *link;
     EXCEPTION_DISPOSITION (*handler)(
 	    struct _EXCEPTION_RECORD*, void*, struct _CONTEXT*, void*);
     void *ebp;
     void *esp;
     int status;
-} EXCEPTION_REGISTRATION;
+} TCL_EXCEPTION_REGISTRATION;
 #endif
 
 /*
@@ -662,7 +662,7 @@
 
 #   else
 
-    EXCEPTION_REGISTRATION registration;
+    TCL_EXCEPTION_REGISTRATION registration;
 
     /*
      * Execute the CPUID instruction with the given index, and store results
@@ -671,7 +671,7 @@
 
     __asm__ __volatile__(
 	/*
-	 * Construct an EXCEPTION_REGISTRATION to protect the CPUID
+	 * Construct an TCL_EXCEPTION_REGISTRATION to protect the CPUID
 	 * instruction (early 486's don't have CPUID)
 	 */
 
@@ -685,7 +685,7 @@
 	"movl	%[error],	0x10(%%edx)"	"\n\t" /* status */
 
 	/*
-	 * Link the EXCEPTION_REGISTRATION on the chain
+	 * Link the TCL_EXCEPTION_REGISTRATION on the chain
 	 */
 
 	"movl	%%edx,		%%fs:0"		"\n\t"
@@ -704,7 +704,7 @@
 	"movl	%%edx,		0xc(%%edi)"	"\n\t"
 
 	/*
-	 * Come here on a normal exit. Recover the EXCEPTION_REGISTRATION and
+	 * Come here on a normal exit. Recover the TCL_EXCEPTION_REGISTRATION and
 	 * store a TCL_OK status.
 	 */
 
@@ -714,7 +714,7 @@
 	"jmp	2f"				"\n"
 
 	/*
-	 * Come here on an exception. Get the EXCEPTION_REGISTRATION that we
+	 * Come here on an exception. Get the TCL_EXCEPTION_REGISTRATION that we
 	 * previously put on the chain.
 	 */
 
@@ -724,7 +724,7 @@
 
 	/*
 	 * Come here however we exited. Restore context from the
-	 * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	 * TCL_EXCEPTION_REGISTRATION in case the stack is unbalanced.
 	 */
 
 	"2:"					"\t"
diff -b -B -u -r ../work.orig/tcl8.6.1/win/tclWinChan.c ./tcl8.6.1/win/tclWinChan.c
--- ../work.orig/tcl8.6.1/win/tclWinChan.c	2013-09-19 21:04:17.000000000 +0200
+++ ./tcl8.6.1/win/tclWinChan.c	2014-05-09 23:27:33.653029761 +0200
@@ -124,17 +124,17 @@
 /*
  * Unlike Borland and Microsoft, we don't register exception handlers by
  * pushing registration records onto the runtime stack. Instead, we register
- * them by creating an EXCEPTION_REGISTRATION within the activation record.
+ * them by creating an TCL_EXCEPTION_REGISTRATION within the activation record.
  */
 
-typedef struct EXCEPTION_REGISTRATION {
-    struct EXCEPTION_REGISTRATION *link;
+typedef struct TCL_EXCEPTION_REGISTRATION {
+    struct TCL_EXCEPTION_REGISTRATION *link;
     EXCEPTION_DISPOSITION (*handler)(
 	    struct _EXCEPTION_RECORD*, void*, struct _CONTEXT*, void*);
     void *ebp;
     void *esp;
     int status;
-} EXCEPTION_REGISTRATION;
+} TCL_EXCEPTION_REGISTRATION;
 #endif
 
 /*
@@ -1030,7 +1030,7 @@
 				 * TCL_WRITABLE to indicate file mode. */
 {
 #if defined(HAVE_NO_SEH) && !defined(_WIN64)
-    EXCEPTION_REGISTRATION registration;
+    TCL_EXCEPTION_REGISTRATION registration;
 #endif
     char channelName[16 + TCL_INTEGER_SPACE];
     Tcl_Channel channel = NULL;
@@ -1111,7 +1111,7 @@
 	    "movl       %[dupedHandle], %%ebx"          "\n\t"
 
 	    /*
-	     * Construct an EXCEPTION_REGISTRATION to protect the call to
+	     * Construct an TCL_EXCEPTION_REGISTRATION to protect the call to
 	     * CloseHandle.
 	     */
 
@@ -1125,7 +1125,7 @@
 	    "movl       $0,             0x10(%%edx)"    "\n\t" /* status */
 
 	    /*
-	     * Link the EXCEPTION_REGISTRATION on the chain.
+	     * Link the TCL_EXCEPTION_REGISTRATION on the chain.
 	     */
 
 	    "movl       %%edx,          %%fs:0"         "\n\t"
@@ -1138,7 +1138,7 @@
 	    "call       _CloseHandle@4"                 "\n\t"
 
 	    /*
-	     * Come here on normal exit. Recover the EXCEPTION_REGISTRATION
+	     * Come here on normal exit. Recover the TCL_EXCEPTION_REGISTRATION
 	     * and put a TRUE status return into it.
 	     */
 
@@ -1148,7 +1148,7 @@
 	    "jmp        2f"                             "\n"
 
 	    /*
-	     * Come here on an exception. Recover the EXCEPTION_REGISTRATION
+	     * Come here on an exception. Recover the TCL_EXCEPTION_REGISTRATION
 	     */
 
 	    "1:"                                        "\t"
@@ -1157,7 +1157,7 @@
 
 	    /*
 	     * Come here however we exited. Restore context from the
-	     * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	     * TCL_EXCEPTION_REGISTRATION in case the stack is unbalanced.
 	     */
 
 	    "2:"                                        "\t"
diff -b -B -u -r ../work.orig/tcl8.6.1/win/tclWinFCmd.c ./tcl8.6.1/win/tclWinFCmd.c
--- ../work.orig/tcl8.6.1/win/tclWinFCmd.c	2013-09-19 21:04:17.000000000 +0200
+++ ./tcl8.6.1/win/tclWinFCmd.c	2014-05-09 23:27:33.653029761 +0200
@@ -72,17 +72,17 @@
 /*
  * Unlike Borland and Microsoft, we don't register exception handlers by
  * pushing registration records onto the runtime stack. Instead, we register
- * them by creating an EXCEPTION_REGISTRATION within the activation record.
+ * them by creating an TCL_EXCEPTION_REGISTRATION within the activation record.
  */
 
-typedef struct EXCEPTION_REGISTRATION {
-    struct EXCEPTION_REGISTRATION *link;
+typedef struct TCL_EXCEPTION_REGISTRATION {
+    struct TCL_EXCEPTION_REGISTRATION *link;
     EXCEPTION_DISPOSITION (*handler)(
 	    struct _EXCEPTION_RECORD *, void *, struct _CONTEXT *, void *);
     void *ebp;
     void *esp;
     int status;
-} EXCEPTION_REGISTRATION;
+} TCL_EXCEPTION_REGISTRATION;
 
 #endif
 
@@ -176,7 +176,7 @@
 				 * (native). */
 {
 #if defined(HAVE_NO_SEH) && !defined(_WIN64)
-    EXCEPTION_REGISTRATION registration;
+    TCL_EXCEPTION_REGISTRATION registration;
 #endif
     DWORD srcAttr, dstAttr;
     int retval = -1;
@@ -213,7 +213,7 @@
 	"movl	    %[nativeSrc],   %%ecx"	    "\n\t"
 
 	/*
-	 * Construct an EXCEPTION_REGISTRATION to protect the call to
+	 * Construct an TCL_EXCEPTION_REGISTRATION to protect the call to
 	 * MoveFile.
 	 */
 
@@ -227,7 +227,7 @@
 	"movl	    $0,		    0x10(%%edx)"    "\n\t" /* status */
 
 	/*
-	 * Link the EXCEPTION_REGISTRATION on the chain.
+	 * Link the TCL_EXCEPTION_REGISTRATION on the chain.
 	 */
 
 	"movl	    %%edx,	    %%fs:0"	    "\n\t"
@@ -242,7 +242,7 @@
 	"call	    *%%eax"			    "\n\t"
 
 	/*
-	 * Come here on normal exit. Recover the EXCEPTION_REGISTRATION and
+	 * Come here on normal exit. Recover the TCL_EXCEPTION_REGISTRATION and
 	 * put the status return from MoveFile into it.
 	 */
 
@@ -251,7 +251,7 @@
 	"jmp	    2f"				    "\n"
 
 	/*
-	 * Come here on an exception. Recover the EXCEPTION_REGISTRATION
+	 * Come here on an exception. Recover the TCL_EXCEPTION_REGISTRATION
 	 */
 
 	"1:"					    "\t"
@@ -260,7 +260,7 @@
 
 	/*
 	 * Come here however we exited. Restore context from the
-	 * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	 * TCL_EXCEPTION_REGISTRATION in case the stack is unbalanced.
 	 */
 
 	"2:"					    "\t"
@@ -563,7 +563,7 @@
     const TCHAR *nativeDst)	/* Pathname of file to copy to (native). */
 {
 #if defined(HAVE_NO_SEH) && !defined(_WIN64)
-    EXCEPTION_REGISTRATION registration;
+    TCL_EXCEPTION_REGISTRATION registration;
 #endif
     int retval = -1;
 
@@ -600,7 +600,7 @@
 	"movl	    %[nativeSrc],   %%ecx"	    "\n\t"
 
 	/*
-	 * Construct an EXCEPTION_REGISTRATION to protect the call to
+	 * Construct an TCL_EXCEPTION_REGISTRATION to protect the call to
 	 * CopyFile.
 	 */
 
@@ -614,7 +614,7 @@
 	"movl	    $0,		    0x10(%%edx)"    "\n\t" /* status */
 
 	/*
-	 * Link the EXCEPTION_REGISTRATION on the chain.
+	 * Link the TCL_EXCEPTION_REGISTRATION on the chain.
 	 */
 
 	"movl	    %%edx,	    %%fs:0"	    "\n\t"
@@ -630,7 +630,7 @@
 	"call	    *%%eax"			    "\n\t"
 
 	/*
-	 * Come here on normal exit. Recover the EXCEPTION_REGISTRATION and
+	 * Come here on normal exit. Recover the TCL_EXCEPTION_REGISTRATION and
 	 * put the status return from CopyFile into it.
 	 */
 
@@ -639,7 +639,7 @@
 	"jmp	    2f"				    "\n"
 
 	/*
-	 * Come here on an exception. Recover the EXCEPTION_REGISTRATION
+	 * Come here on an exception. Recover the TCL_EXCEPTION_REGISTRATION
 	 */
 
 	"1:"					    "\t"
@@ -648,7 +648,7 @@
 
 	/*
 	 * Come here however we exited. Restore context from the
-	 * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	 * TCL_EXCEPTION_REGISTRATION in case the stack is unbalanced.
 	 */
 
 	"2:"					    "\t"
diff -b -B -u -r ../work.orig/tcl8.6.1/win/tclWinInt.h ./tcl8.6.1/win/tclWinInt.h
--- ../work.orig/tcl8.6.1/win/tclWinInt.h	2013-09-19 21:04:17.000000000 +0200
+++ ./tcl8.6.1/win/tclWinInt.h	2014-05-09 23:27:33.661029995 +0200
@@ -28,7 +28,11 @@
 #endif
 
 #ifdef _WIN64
+# ifdef __USE_MINGW_ANSI_STDIO
+#         define TCL_I_MODIFIER        "z"
+# else
 #         define TCL_I_MODIFIER        "I"
+# endif
 #else
 #         define TCL_I_MODIFIER        ""
 #endif
diff -b -B -u -r ../work.orig/tk8.6.1/generic/tkEvent.c ./tk8.6.1/generic/tkEvent.c
--- ../work.orig/tk8.6.1/generic/tkEvent.c	2013-09-03 14:52:34.000000000 +0200
+++ ./tk8.6.1/generic/tkEvent.c	2014-05-09 23:28:01.537843343 +0200
@@ -2039,6 +2039,15 @@
 {
     ExitHandler *exitPtr;
 
+    /* There's no guarantee that Tcl_InitStubs
+     * has been called before exit; tclStubsPtr
+     * is NULL in this case.
+     */
+#if defined(USE_TCL_STUBS)
+    if (tclStubsPtr == NULL)
+	    return;
+#endif
+
     Tcl_DeleteExitHandler(TkFinalize, NULL);
 
     Tcl_MutexLock(&exitMutex);
diff -b -B -u -r ../work.orig/tk8.6.1/unix/installManPage ./tk8.6.1/unix/installManPage
--- ../work.orig/tk8.6.1/unix/installManPage	2013-09-17 14:25:13.000000000 +0200
+++ ./tk8.6.1/unix/installManPage	2014-05-09 23:28:01.537843343 +0200
@@ -103,7 +103,7 @@
     Target=$Target.$Section$Suffix
     rm -f $Dir/$Target $Dir/$Target.*
     if test -z "$First" ; then
-	First=$Target
+	First=$(echo $Target | sed -e 's/:/-/g')
 	sed -e "/man\.macros/r $SrcDir/man.macros" -e "/man\.macros/d" \
 	    $ManPage > $Dir/$First
 	chmod 444 $Dir/$First
Nur in ./tk8.6.1/unix: installManPage.orig.
diff -b -B -u -r ../work.orig/tk8.6.1/win/configure.in ./tk8.6.1/win/configure.in
--- ../work.orig/tk8.6.1/win/configure.in	2013-09-17 14:25:14.000000000 +0200
+++ ./tk8.6.1/win/configure.in	2014-05-09 23:28:01.537843343 +0200
@@ -166,7 +166,11 @@
 eval "TK_SRC_DIR=\"`cd $srcdir/..; pwd`\""
 
 eval "TK_DLL_FILE=tk$VER${DLLSUFFIX}"
-eval "TK_LIB_FILE=${LIBPREFIX}tk$VER${LIBSUFFIX}"
+if test ${SHARED_BUILD} = 0 ; then
+  eval "TK_LIB_FILE=${LIBPREFIX}tk$VER${LIBSUFFIX}"
+else
+  eval "TK_LIB_FILE=${LIBPREFIX}tk$VER${DLLSUFFIX}${LIBSUFFIX}"
+fi
 
 eval "TK_STUB_LIB_FILE=${LIBPREFIX}tkstub${VER}${LIBSUFFIX}"
 # FIXME: All of this var junk needs to be done in tcl.m4 !!!!
diff -b -B -u -r ../work.orig/tk8.6.1/win/Makefile.in ./tk8.6.1/win/Makefile.in
--- ../work.orig/tk8.6.1/win/Makefile.in	2013-09-17 14:25:14.000000000 +0200
+++ ./tk8.6.1/win/Makefile.in	2014-05-09 23:28:01.537843343 +0200
@@ -135,7 +135,7 @@
 TK_LIB_FILE		= @TK_LIB_FILE@
 TK_DLL_FILE		= @TK_DLL_FILE@
 TEST_DLL_FILE		= tktest$(VER)${DLLSUFFIX}
-TEST_LIB_FILE		= @LIBPREFIX@tktest$(VER)${LIBSUFFIX}
+TEST_LIB_FILE		= @LIBPREFIX@tktest$(VER)${DLLSUFFIX}${LIBSUFFIX}
 
 SHARED_LIBRARIES 	= $(TK_DLL_FILE) $(TK_STUB_LIB_FILE)
 STATIC_LIBRARIES	= $(TK_LIB_FILE)
@@ -590,6 +590,27 @@
 	    done;
 
 install-doc: doc
+	@for i in "$(MAN_INSTALL_DIR)" "$(MAN1_INSTALL_DIR)" "$(MAN3_INSTALL_DIR)" "$(MANN_INSTALL_DIR)" ; \
+	    do \
+	    if [ ! -d "$$i" ] ; then \
+		echo "Making directory $$i"; \
+		mkdir -p "$$i"; \
+		chmod 755 "$$i"; \
+		else true; \
+		fi; \
+	    done;
+	@echo "Installing and cross-linking top-level (.1) docs";
+	@for i in $(ROOT_DIR)/doc/*.1; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MAN1_INSTALL_DIR)"; \
+	done
+	@echo "Installing and cross-linking C API (.3) docs";
+	@for i in $(ROOT_DIR)/doc/*.3; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MAN3_INSTALL_DIR)"; \
+	done
+	@echo "Installing and cross-linking command (.n) docs";
+	@for i in $(ROOT_DIR)/doc/*.n; do \
+	    $(SHELL) $(UNIX_DIR)/installManPage $(MAN_FLAGS) $$i "$(MANN_INSTALL_DIR)"; \
+	done
 
 # Optional target to install private headers
 install-private-headers: libraries
diff -b -B -u -r ../work.orig/tk8.6.1/win/tcl.m4 ./tk8.6.1/win/tcl.m4
--- ../work.orig/tk8.6.1/win/tcl.m4	2013-09-17 14:25:14.000000000 +0200
+++ ./tk8.6.1/win/tcl.m4	2014-05-09 23:28:01.537843343 +0200
@@ -715,7 +715,7 @@
 	SHLIB_LD='${CC} -shared ${CFLAGS}'
 	SHLIB_LD_LIBS='${LIBS}'
 	MAKE_DLL="\${SHLIB_LD} \$(LDFLAGS) -o \[$]@ ${extra_ldflags} \
-	    -Wl,--out-implib,\$(patsubst %.dll,lib%.a,\[$]@)"
+	    -Wl,--out-implib,\$(patsubst %.dll,lib%.dll.a,\[$]@)"
 	# DLLSUFFIX is separate because it is the building block for
 	# users of tclConfig.sh that may build shared or static.
 	DLLSUFFIX="\${DBGX}.dll"
diff -b -B -u -r ../work.orig/tk8.6.1/win/tkWin32Dll.c ./tk8.6.1/win/tkWin32Dll.c
--- ../work.orig/tk8.6.1/win/tkWin32Dll.c	2013-09-03 14:52:37.000000000 +0200
+++ ./tk8.6.1/win/tkWin32Dll.c	2014-05-09 23:28:01.541843460 +0200
@@ -17,17 +17,17 @@
 /*
  * Unlike Borland and Microsoft, we don't register exception handlers by
  * pushing registration records onto the runtime stack. Instead, we register
- * them by creating an EXCEPTION_REGISTRATION within the activation record.
+ * them by creating an TCLEXCEPTION_REGISTRATION within the activation record.
  */
 
-typedef struct EXCEPTION_REGISTRATION {
-    struct EXCEPTION_REGISTRATION *link;
+typedef struct TCLEXCEPTION_REGISTRATION {
+    struct TCLEXCEPTION_REGISTRATION *link;
     EXCEPTION_DISPOSITION (*handler)(
 	    struct _EXCEPTION_RECORD*, void*, struct _CONTEXT*, void*);
     void *ebp;
     void *esp;
     int status;
-} EXCEPTION_REGISTRATION;
+} TCLEXCEPTION_REGISTRATION;
 
 /*
  * Need to add noinline flag to DllMain declaration so that gcc -O3 does not
@@ -102,7 +102,7 @@
     LPVOID reserved)
 {
 #ifdef HAVE_NO_SEH
-    EXCEPTION_REGISTRATION registration;
+    TCLEXCEPTION_REGISTRATION registration;
 #endif
 
     /*
@@ -127,7 +127,7 @@
 	__asm__ __volatile__ (
 
 	    /*
-	     * Construct an EXCEPTION_REGISTRATION to protect the call to
+	     * Construct an TCLEXCEPTION_REGISTRATION to protect the call to
 	     * TkFinalize
 	     */
 
@@ -141,7 +141,7 @@
 	    "movl	%[error],	0x20(%%rdx)"	"\n\t" /* status */
 
 	    /*
-	     * Link the EXCEPTION_REGISTRATION on the chain
+	     * Link the TCLEXCEPTION_REGISTRATION on the chain
 	     */
 
 	    "movq	%%rdx,		%%gs:0"		"\n\t"
@@ -154,7 +154,7 @@
 	    "call	TkFinalize"			"\n\t"
 
 	    /*
-	     * Come here on a normal exit. Recover the EXCEPTION_REGISTRATION
+	     * Come here on a normal exit. Recover the TCLEXCEPTION_REGISTRATION
 	     * and store a TCL_OK status
 	     */
 
@@ -164,7 +164,7 @@
 	    "jmp	2f"				"\n"
 
 	    /*
-	     * Come here on an exception. Get the EXCEPTION_REGISTRATION that
+	     * Come here on an exception. Get the TCLEXCEPTION_REGISTRATION that
 	     * we previously put on the chain.
 	     */
 
@@ -174,7 +174,7 @@
 
 	    /*
 	     * Come here however we exited. Restore context from the
-	     * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	     * TCLEXCEPTION_REGISTRATION in case the stack is unbalanced.
 	     */
 
 	    "2:"					"\t"
@@ -197,7 +197,7 @@
 	__asm__ __volatile__ (
 
 	    /*
-	     * Construct an EXCEPTION_REGISTRATION to protect the call to
+	     * Construct an TCLEXCEPTION_REGISTRATION to protect the call to
 	     * TkFinalize
 	     */
 
@@ -211,7 +211,7 @@
 	    "movl	%[error],	0x10(%%edx)"	"\n\t" /* status */
 
 	    /*
-	     * Link the EXCEPTION_REGISTRATION on the chain
+	     * Link the TCLEXCEPTION_REGISTRATION on the chain
 	     */
 
 	    "movl	%%edx,		%%fs:0"		"\n\t"
@@ -224,7 +224,7 @@
 	    "call	_TkFinalize"			"\n\t"
 
 	    /*
-	     * Come here on a normal exit. Recover the EXCEPTION_REGISTRATION
+	     * Come here on a normal exit. Recover the TCLEXCEPTION_REGISTRATION
 	     * and store a TCL_OK status
 	     */
 
@@ -234,7 +234,7 @@
 	    "jmp	2f"				"\n"
 
 	    /*
-	     * Come here on an exception. Get the EXCEPTION_REGISTRATION that
+	     * Come here on an exception. Get the TCLEXCEPTION_REGISTRATION that
 	     * we previously put on the chain.
 	     */
 
@@ -245,7 +245,7 @@
 
 	    /*
 	     * Come here however we exited. Restore context from the
-	     * EXCEPTION_REGISTRATION in case the stack is unbalanced.
+	     * TCLEXCEPTION_REGISTRATION in case the stack is unbalanced.
 	     */
 
 	    "2:"					"\t"
